<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付网关 - 支付学习网</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="../index.html">💳 支付学习网</a>
            </div>
            <ul class="nav-menu">
                <li><a href="../index.html">首页</a></li>
                <li><a href="basics.html">支付基础</a></li>
                <li><a href="gateways.html" class="active">支付网关</a></li>
                <li><a href="simulator.html">支付模拟</a></li>
                <li><a href="security.html">安全机制</a></li>
            </ul>
            <div class="hamburger"><span></span><span></span><span></span></div>
        </div>
    </nav>

    <!-- 页面头部 -->
    <div class="page-header">
        <div class="container">
            <h1>💰 支付网关</h1>
            <p>商户与银行之间的桥梁</p>
        </div>
    </div>

    <main>
        <div class="container">
            <!-- 什么是支付网关 -->
            <div class="content">
                <h2>🌉 核心定位</h2>
                <div class="highlight-box info">
                    <div class="highlight-title info-title">🔗 支付网关 = 商户系统 ↔ 银行系统 的翻译官</div>
                    <p>负责<strong>交易路由、协议转换、数据加密、结果通知</strong></p>
                </div>
            </div>

            <!-- 主流支付网关对比 -->
            <div class="content">
                <h2>🏢 主流网关对比</h2>
                <table class="gateway-compare">
                    <thead>
                        <tr>
                            <th>网关</th>
                            <th>用户量</th>
                            <th>覆盖</th>
                            <th>特点</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="gateway-name">💙 支付宝</td>
                            <td>10亿+</td>
                            <td>中国</td>
                            <td>功能最全、AI风控、刷脸支付</td>
                        </tr>
                        <tr>
                            <td class="gateway-name">💚 微信支付</td>
                            <td>13亿+</td>
                            <td>中国</td>
                            <td>小程序生态、私域流量</td>
                        </tr>
                        <tr>
                            <td class="gateway-name">💜 Stripe</td>
                            <td>全球</td>
                            <td>135+国家</td>
                            <td>开发者友好、多币种</td>
                        </tr>
                        <tr>
                            <td class="gateway-name">💙 PayPal</td>
                            <td>4亿+</td>
                            <td>190+国家</td>
                            <td>跨境支付、买家保护</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 集成步骤 -->
            <div class="content">
                <h2>🔧 集成四步走</h2>
                <div class="flow-chart-horizontal">
                    <div class="flow-node">
                        <div class="flow-node-circle">📝</div>
                        <div class="flow-node-title">1. 注册商户</div>
                        <div class="flow-node-content">
                            <ul>
                                <li>营业执照</li>
                                <li>法人身份证</li>
                                <li>银行账户</li>
                            </ul>
                        </div>
                    </div>
                    <div class="flow-node">
                        <div class="flow-node-circle">🔑</div>
                        <div class="flow-node-title">2. 获取密钥</div>
                        <div class="flow-node-content">
                            <ul>
                                <li>merchant_id</li>
                                <li>API Key</li>
                                <li>应用AppID</li>
                            </ul>
                        </div>
                    </div>
                    <div class="flow-node">
                        <div class="flow-node-circle">📦</div>
                        <div class="flow-node-title">3. 接入SDK</div>
                        <div class="flow-node-content">
                            <ul>
                                <li>服务端SDK</li>
                                <li>客户端SDK</li>
                                <li>配置密钥</li>
                            </ul>
                        </div>
                    </div>
                    <div class="flow-node">
                        <div class="flow-node-circle">🧪</div>
                        <div class="flow-node-title">4. 沙箱测试</div>
                        <div class="flow-node-content">
                            <ul>
                                <li>下单接口</li>
                                <li>回调通知</li>
                                <li>退款流程</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ⭐⭐⭐ 核心难点 ⭐⭐⭐ -->
            <div class="content" style="border: 3px solid #ff6b00; border-radius: 16px; margin: 30px 0;">
                <h2 style="color: #ff6b00;">🔥🔥🔥 核心难点（必看）</h2>
                
                <!-- 难点1: 签名机制 -->
                <div class="core-concept">
                    <div class="concept-card signature">
                        <div class="concept-card-title">🔐 1. 签名机制</div>
                        <div class="concept-card-desc">
                            所有请求必须带签名，防止数据被篡改<br><br>
                            <strong>签名流程：</strong>
                        </div>
                        <div class="code-block">
<span class="comment"># 1. 参数按字典序排序</span>
params = {<span class="string">"amount"</span>: <span class="string">"100"</span>, <span class="string">"merchant_id"</span>: <span class="string">"M001"</span>}
sorted_params = <span class="function">sorted</span>(params.items())

<span class="comment"># 2. 拼接成字符串</span>
sign_str = <span class="string">"amount=100&merchant_id=M001&key=YOUR_KEY"</span>

<span class="comment"># 3. HMAC-SHA256 加密</span>
sign = <span class="function">hmac_sha256</span>(sign_str, <span class="string">"YOUR_KEY"</span>)
                        </div>
                        <div class="concept-card-importance">⚠️ 难点：密钥泄露 = 资金被盗！必须使用环境变量存储</div>
                    </div>

                    <!-- 难点2: 异步回调 -->
                    <div class="concept-card callback">
                        <div class="concept-card-title">📬 2. 异步回调</div>
                        <div class="concept-card-desc">
                            支付完成后，平台主动通知商户结果
                        </div>
                        <div class="highlight-box danger" style="margin: 15px 0;">
                            <div class="highlight-title danger-title">⚠️ 三大坑</div>
                            <p>1. <strong>回调可能不来</strong> - 网络问题导致丢消息<br>
                            2. <strong>回调可能重复</strong> - 商户没返回success会重试<br>
                            3. <strong>回调可能被伪造</strong> - 黑客模拟回调</p>
                        </div>
                        <div class="code-block">
<span class="comment"># 正确的回调处理</span>
<span class="keyword">def</span> <span class="function">handle_callback</span>(params):
    <span class="comment"># 1. 验证签名（最重要！）</span>
    <span class="keyword">if not</span> <span class="function">verify_sign</span>(params):
        <span class="keyword">return</span> <span class="string">"fail"</span>
    
    <span class="comment"># 2. 幂等处理 - 防止重复</span>
    trade_no = params[<span class="string">"trade_no"</span>]
    <span class="keyword">if</span> <span class="function">is_processed</span>(trade_no):
        <span class="keyword">return</span> <span class="string">"success"</span>
    
    <span class="comment"># 3. 更新订单状态</span>
    <span class="function">update_order</span>(params)
    <span class="function">save_processed</span>(trade_no)
    
    <span class="keyword">return</span> <span class="string">"success"</span>
                        </div>
                        <div class="concept-card-importance">⚠️ 难点：3秒内必须返回"success"，否则平台会重试</div>
                    </div>

                    <!-- 难点3: 幂等性 -->
                    <div class="concept-card idempotent">
                        <div class="concept-card-title">🔄 3. 幂等性设计</div>
                        <div class="concept-card-desc">
                            同一个请求重复执行，结果一致
                        </div>
                        <div class="highlight-box warning" style="margin: 15px 0;">
                            <div class="highlight-title warning-title">💡 为什么要幂等？</div>
                            <p>• 用户重复点击支付按钮<br>
                            • 网络超时导致重试<br>
                            • 回调重复通知</p>
                        </div>
                        <div class="code-block">
<span class="comment"># 使用唯一订单号作为幂等键</span>
<span class="keyword">def</span> <span class="function">create_order</span>(out_trade_no, amount):
    <span class="comment"># 检查订单是否已存在</span>
    order = <span class="function">db.get_order</span>(out_trade_no)
    <span class="keyword">if</span> order:
        <span class="keyword">return</span> order  <span class="comment"># 已存在，直接返回</span>
    
    <span class="comment"># 不存在，创建新订单</span>
    order = <span class="function">db.create_order</span>(...)
    <span class="keyword">return</span> order
                        </div>
                        <div class="concept-card-importance">💡 核心：用 out_trade_no（商户订单号）作为唯一约束</div>
                    </div>

                    <!-- 难点4: 超时处理 -->
                    <div class="concept-card timeout">
                        <div class="concept-card-title">⏰ 4. 超时与状态查询</div>
                        <div class="concept-card-desc">
                            支付超时了怎么办？
                        </div>
                        <div class="highlight-box info" style="margin: 15px 0;">
                            <div class="highlight-title info-title">🔄 解决方案：主动查询</div>
                            <p>支付成功后，页面卡住了 → 调用查询接口确认状态</p>
                        </div>
                        <div class="code-block">
<span class="comment"># 超时后的处理流程</span>
<span class="keyword">def</span> <span class="function">pay_with_timeout</span>(order_id):
    <span class="keyword">try</span>:
        result = <span class="function">request_payment</span>(order_id, timeout=<span class="string">"30s"</span>)
    <span class="keyword">except</span> Timeout:
        <span class="comment"># 超时了？立即查询状态</span>
        status = <span class="function">query_order_status</span>(order_id)
        <span class="keyword">if</span> status == <span class="string">"SUCCESS"</span>:
            <span class="keyword">return</span> <span class="string">"已支付"</span>
        <span class="keyword">else</span>:
            <span class="keyword">return</span> <span class="string">"支付中，请稍后查询"</span>
                        </div>
                        <div class="concept-card-importance">⚠️ 难点：订单状态以查询结果为准，别信前端</div>
                    </div>
                </div>
            </div>

            <!-- 订单状态流转 -->
            <div class="content">
                <h2>📋 订单状态流转</h2>
                <div class="status-flow">
                    <div class="status-box created">CREATED</div>
                    <div class="status-arrow">→</div>
                    <div class="status-box wait">WAIT_PAY</div>
                    <div class="status-arrow">→</div>
                    <div class="status-box success">SUCCESS</div>
                    <div class="status-arrow">→</div>
                    <div class="status-box refund">REFUND</div>
                </div>
                <div class="status-flow">
                    <div class="status-box wait">WAIT_PAY</div>
                    <div class="status-arrow">→</div>
                    <div class="status-box closed">CLOSED (超时关闭)</div>
                </div>
            </div>

            <!-- 常见错误 -->
            <div class="content">
                <h2>⚠️ 常见错误码</h2>
                <table class="api-table">
                    <thead>
                        <tr>
                            <th>错误码</th>
                            <th>含义</th>
                            <th>解决方案</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td><strong>1001</strong></td><td>参数错误</td><td>检查必填参数是否完整</td></tr>
                        <tr><td><strong>1002</strong></td><td>签名失败</td><td>检查签名算法和密钥</td></tr>
                        <tr><td><strong>1003</strong></td><td>订单不存在</td><td>检查订单号是否正确</td></tr>
                        <tr><td><strong>1004</strong></td><td>订单状态异常</td><td>别重复操作，换查询接口</td></tr>
                        <tr><td><strong>1005</strong></td><td>余额不足</td><td>提示用户充值</td></tr>
                        <tr><td><strong>1006</strong></td><td>系统繁忙</td><td>稍后重试</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- 核心API -->
            <div class="content">
                <h2>📡 四个核心接口</h2>
                <div class="highlight-box success">
                    <div class="highlight-title success-title">📝 接口清单</div>
                    <p>
                        <strong>1. 统一下单</strong> /api/payment/create - 创建支付订单<br>
                        <strong>2. 支付查询</strong> /api/payment/query - 查询订单状态<br>
                        <strong>3. 申请退款</strong> /api/payment/refund - 退款操作<br>
                        <strong>4. 异步回调</strong> 商户提供notify_url - 接收支付结果
                    </p>
                </div>
            </div>
        </div>
    </main>

    <footer><div class="container"></div></footer>
    <script src="../js/main.js"></script>
</body>
</html>
